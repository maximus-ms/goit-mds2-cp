# **Тиждень 4. Щотижневий звіт про прогрес виконання дипломної роботи**

**Тема:** Система інтелектуальної діагностики технічних пристроїв на основі акустичних сигналів з використанням методів машинного навчання

## 1. Опис виконаних завдань та прогрес (MVP Phase 3)

Цей тиждень був присвячений розширеній інтеграції компонентів, оптимізації інфраструктури ML-пайплайну, тестуванню моделі в реальних умовах та підготовці до другого демо.

### 1.1. Налаштування MLflow інфраструктури для відстеження експериментів

* **Піднято MLflow Tracking Server:**
    * Налаштовано MLflow Tracking Server на `http://192.168.3.58:5000` для централізованого відстеження всіх експериментів
    * Налаштовано S3-сумісне сховище (MinIO) на `http://192.168.3.58:9000` для зберігання артефактів (моделі, checkpoints, графіки)
    * Налаштовано змінні середовища для інтеграції з MLflow (`MLFLOW_S3_ENDPOINT_URL`, `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`)

* **Інтеграція MLflow у процес тренування:**
    * Оновлено функцію `train_mlflow()` для повної інтеграції з MLflow
    * Реалізовано автоматичне логування:
        * Параметрів моделі (learning rate, batch size, embedding dimension, архітектура)
        * Метрик тренування (loss, validation metrics) в реальному часі
        * Артефактів (checkpoints, моделі, графіки, історія тренування)
    * Додано підтримку Early Stopping з логуванням в MLflow
    * Налаштовано автоматичне збереження найкращих моделей та фінальних моделей

* **Інтеграція MLflow у процес верифікації:**
    * Оновлено функцію `validate_mlflow()` для автоматичного логування результатів
    * Реалізовано логування метрик верифікації (accuracy, precision, recall, F1-score)
    * Додано можливість підключення до існуючого MLflow run для логування результатів
    * Автоматичне збереження результатів верифікації, CSV файлів та гістограм в MLflow

### 1.2. Тестування моделі в реальних умовах та друге демо

* **Тестування на реальному обладнанні:**
    * Проведено серію тестів натренованої моделі на **3D принтері** як тестовому промисловому обладнанні
    * Виконано **3 тести** для перевірки роботи моделі в реальних умовах експлуатації
    * **Результат:** Задовільні результати отримано лише в **1 з 3 тестів**
    * Виявлено проблеми з узагальненням моделі для конкретного обладнання

* **Зустріч з науковим керівником (Друге демо):**
    * Проведено презентацію результатів роботи з науковим керівником
    * Представлено натреновану модель та її архітектуру
    * Презентовано результати тестів з реальним обладнанням (3D принтер)
    * Обговорено отримані результати тестування та проблеми з узагальненням моделі
    * Проаналізовано причини невдач у двох з трьох тестів
    * Обговорено можливі стратегії покращення моделі

* **Нова ідея для покращення якості семплів:**
    * У ході обговорення запропоновано новий підхід до покращення якості отриманого семплу
    * **Концепція:** Використання **4 мікрофонів** для виділення корисного сигналу від агрегату, що моніториться
    * **Конфігурація мікрофонів:**
        * 3 мікрофони направлені на агрегат (для захоплення корисного сигналу)
        * 1 мікрофон направлений у зворотному напрямку (для моніторингу загального фонового шуму)
    * **Алгоритм обробки:**
        1. Віднімання фонового шуму (з 4-го мікрофона) від сигналів трьох мікрофонів, спрямованих на агрегат
        2. Додавання отриманих трьох каналів між собою для отримання очищеного корисного сигналу
    * Ідея визнана цікавою та перспективною для подальшого розвитку пристрою

### 1.3. Покращення стратегії тренування моделі

* **Оновлення даталоадера:**
    * Оновлено скрипт обробки датасету для включення abnormal семплів (раніше зберігалися лише normal семпли)
    * Модифіковано даталоадер з новою логікою формування помилкових (негативних) семплів:
        * **50%** помилкових семплів береться як abnormal семпли від тієї самої машини ID
        * **50%** помилкових семплів залишаються від інших машин (як було раніше)
    * Теоретично це має дозволяти моделі краще розпізнавати аномалії конкретної машини під час тренування

* **Виявлення та виправлення помилок:**
    * Після перетренування з оновленим даталоадером результати виявилися дуже поганими
    * Проведено дебаг даталоадера для виявлення причини погіршення результатів
    * Виявлено та виправлено помилки в логіці формування тренувальних триплетів (anchor, positive, negative)
    * Перевірено та виправлено коректність балансування між різними типами негативних семплів

* **Перетренування моделі:**
    * Проведено перетренування моделі після виправлення помилок у даталоадері
    * Використано abnormal семпли від тієї самої машини ID для формування негативних семплів
    * Всі параметри тренування залоговані в MLflow для подальшого аналізу
    * **Результат:** Виявлено ознаки перенавчання (overfitting) моделі

### 1.4. Повна модуляризація ML інфраструктури

* **Рефакторинг та винесення компонентів в окремі модулі:**
    * Створено самостійний скрипт `project/host/ml/prepare_dataset.py` для обробки датасетів з підтримкою як MIMII датасету, так і кастомних датасетів
    * Винесено клас `TripletMemoryDataset` в окремий модуль `project/host/ml/triplet_memory_dataset.py`
    * Винесено архітектуру моделі `TinyAudioCNN` в окремий модуль `project/host/ml/model.py` з усіма супутніми компонентами
    * Винесено клас `EarlyStopping` в окремий модуль `project/host/ml/early_stopping.py` з підтримкою різних критеріїв зупинки
    * Винесено функцію тренування моделі в окремий модуль `project/host/ml/train.py` з повною інтеграцією MLflow
    * Винесено модуль тестування та валідації моделі в `project/host/ml/test.py` з інтеграцією MLflow

* **Покращення інфраструктури:**
    * Створено файл `project/host/ml/requirements.txt` з усіма необхідними залежностями
    * Інтегровано підтримку `python-dotenv` для конфігурації через `.env` файл
    * Створено `project/host/ml/env.example` з прикладом конфігурації
    * Перероблено логування: замінено всі `print()` на використання модуля `logging` з структурованим логуванням
    * Додано опції `--verbose` та `--quiet` для керування рівнем логування

* **Уніфікація обробки аудіо:**
    * Додано статичний метод `create_mel_transform` до класу `TripletMemoryDataset` для створення трансформ спектрограм
    * Перенесено функцію `load_and_process_wav_file` з `TripletMemoryDataset` в `project/host/ml/prepare_dataset.py` для забезпечення однакової логіки обробки
    * Уніфіковано код обробки аудіо: всі модулі використовують однакову логіку обробки, що гарантує консистентність результатів

* **Розширення функціональності модуля тестування:**
    * Додано режим тестування (`--test`) для швидкої перевірки інфраструктури модуля без необхідності завантаження моделі або датасету
    * Додано режим тестування двох WAV файлів (`--normal` та `--anomaly`) для швидкого тестування моделі на кастомних аудіо файлах
    * Динамічне визначення типів машин для тестування з датасету (узгоджено з логікою тренування та верифікації)
    * Підтримка завантаження моделей з MLflow (URI, run_id) або локальних файлів

## 2. Результати другого демо та висновки

### 2.1. Результати тестування в реальних умовах

Проведено серію тестів натренованої моделі на реальному промисловому обладнанні (3D принтер):

* **Результати:** Задовільні результати отримано лише в **1 з 3 тестів**
* **Виявлені проблеми:**
    * Модель показала проблеми з узагальненням для конкретного обладнання
    * Необхідність покращення розпізнавання аномалій для реальних умов експлуатації
    * Модель, натренована на датасеті MIMII, не завжди коректно працює з реальними сигналами

### 2.2. Отримані рекомендації від наукового керівника

* **Проблема узагальнення моделі:** Необхідно провести додатковий аналіз причин невдач та розробити стратегії покращення
* **Покращення якості вхідних даних:** Запропоновано ідею з використанням 4 мікрофонів для виділення корисного сигналу через віднімання фонового шуму
* **Оптимізація процесу тренування:** Виявлено ознаки перенавчання моделі, необхідно розробити стратегії боротьби з overfitting

### 2.3. Висновки та стратегічні рішення

* **Перенавчання моделі:** Після перетренування з використанням abnormal семплів від тієї самої машини виявлено ознаки перенавчання. Потрібен додатковий аналіз для визначення причин та розробки стратегій оптимізації.

* **Модульна архітектура:** Повна модуляризація ML інфраструктури значно покращила підтримуваність та гнучкість проєкту. Всі основні компоненти ML пайплайну тепер є окремими модулями, що спрощує тестування, підтримку та розширення функціональності.

* **MLflow інфраструктура:** Повна інтеграція MLflow для відстеження експериментів забезпечила централізоване зберігання всіх результатів тренування та верифікації, що дозволяє легко порівнювати різні експерименти та аналізувати результати.

## 3. Ризики, виклики та їх вирішення

### 3.1. Проблема узагальнення моделі в реальних умовах

* **Проблема:** Модель, натренована на датасеті MIMII, показала задовільні результати лише в 1 з 3 тестів на реальному обладнанні (3D принтер). Виявлено проблеми з узагальненням моделі для конкретного обладнання.

* **Причини:**
    * Різниця між умовами запису датасету MIMII та реальними умовами експлуатації
    * Відмінності в характеристиках обладнання та фонового шуму
    * Можлива недостатня різноманітність даних у тренувальному наборі

* **Шляхи вирішення:**
    * Розробка стратегій покращення якості вхідних даних (ідея з 4 мікрофонами для віднімання фонового шуму)
    * Проведення додаткового збору даних з реального обладнання для fine-tuning моделі
    * Використання технік data augmentation для збільшення різноманітності тренувальних даних
    * Аналіз та оптимізація гіперпараметрів моделі

### 3.2. Перенавчання моделі (Overfitting)

* **Проблема:** Після перетренування з використанням abnormal семплів від тієї самої машини виявлено ознаки перенавчання моделі. Висока точність на тренувальному наборі, але значно нижча точність на валідаційному/тестовому наборі.

* **Причини:**
    * Можлива недостатня різноманітність тренувальних даних
    * Складність моделі може бути занадто високою для наявного обсягу даних
    * Використання abnormal семплів від тієї самої машини може сприяти перенавчанню на конкретні паттерни

* **Шляхи вирішення:**
    * Додавання regularization (dropout, weight decay) для зменшення складності моделі
    * Збільшення розміру датасету через data augmentation
    * Зменшення складності моделі або використання технік прунінгу
    * Оптимізація стратегії формування тренувальних триплетів
    * Проведення детального аналізу метрик тренування та валідації для виявлення паттернів

### 3.3. Складність інтеграції та підтримки ML інфраструктури

* **Проблема:** Початкова інфраструктура була розкидана по різних файлах (Jupyter notebooks, окремі скрипти), що ускладнювало підтримку та розширення функціональності.

* **Рішення:** Проведено повну модуляризацію ML інфраструктури:
    * Всі компоненти винесені в окремі модулі з чіткою структурою
    * Створено `requirements.txt` для легкого встановлення залежностей
    * Застосовано структуроване логування для діагностики та моніторингу
    * Уніфіковано логіку обробки аудіо в усіх модулях
    * Інтегровано підтримку `.env` файлів для конфігурації

## 4. План роботи на наступний тиждень (Тиждень 5)

Фокус зміщується на оптимізацію моделі та подальше тестування.

1. **Аналіз та оптимізація моделі:**
    * Провести детальний аналіз причин перенавчання моделі
    * Розробити та реалізувати стратегії боротьби з overfitting:
        * Додавання regularization (dropout, weight decay)
        * Оптимізація гіперпараметрів моделі
        * Розгляд можливості зменшення складності моделі
    * Порівняти метрики тренування та валідації для виявлення паттернів
    * Провести додаткові експерименти з різними гіперпараметрами

2. **Покращення якості вхідних даних:**
    * Розробити детальний план реалізації ідеї з 4 мікрофонами для покращення якості сигналу
    * Оцінити технічну складність та необхідні зміни в апаратній частині
    * Провести теоретичний аналіз ефективності запропонованого підходу

3. **Подальше тестування:**
    * Після оптимізації моделі провести повторне тестування на реальному обладнанні
    * Зібрати додаткові дані з реального обладнання для fine-tuning моделі
    * Порівняти результати до та після оптимізації

4. **Документування:**
    * Оновити документацію проєкту з урахуванням змін в архітектурі
    * Задокументувати результати тестування та отримані висновки
    * Підготувати опис нової модульної архітектури ML інфраструктури

## 5. Артефакти

* **GitHub Репозиторій:** Структура проєкту доповнена наступними модулями:
    * `project/host/ml/prepare_dataset.py` — скрипт для обробки датасетів (MIMII та кастомні)
    * `project/host/ml/triplet_memory_dataset.py` — клас даталоадера TripletMemoryDataset
    * `project/host/ml/model.py` — архітектура моделі TinyAudioCNN з усіма супутніми компонентами
    * `project/host/ml/early_stopping.py` — клас EarlyStopping з підтримкою різних критеріїв зупинки
    * `project/host/ml/train.py` — модуль тренування з повною інтеграцією MLflow
    * `project/host/ml/test.py` — модуль тестування та валідації моделі з інтеграцією MLflow
    * `project/host/ml/requirements.txt` — файл з усіма необхідними залежностями
    * `project/host/ml/env.example` — приклад конфігурації через `.env` файл

* **MLflow Tracking Server:**
    * Всі експерименти з тренування та верифікації залоговані в MLflow
    * Артефакти (моделі, checkpoints, графіки) зберігаються в MinIO/S3
    * Доступ до результатів: `http://192.168.3.58:5000`

* **Результати тестування:**
    * Результати тестування моделі на 3D принтері (1 успішний тест з 3)
    * Зафіксовані проблеми з узагальненням моделі для реальних умов

* **Документація:**
    * Оновлена структура проєкту з модульною архітектурою ML компонентів

